---
- name: zsh - Install
  ansible.builtin.apt:
    name:
      - zsh
    state: present


- name: zsh - Create zsh config dir
  ansible.builtin.file:
    path: '/home/{{ user_name }}/.config/zsh/'
    state: directory
    owner: '{{ user_name }}'
    group: '{{ user_name }}'
    mode: 0755
  become: false


- name: zsh - Install oh-my-zsh
  ansible.builtin.git:
    repo: https://github.com/ohmyzsh/ohmyzsh.git
    dest: '/home/{{ user_name }}/.oh-my-zsh/'
    clone: true
    depth: 1
    update: true
  become: false

- name: zsh - Install oh-my-zsh plugins
  ansible.builtin.git:
    repo: 'https://github.com/zsh-users/{{ plugin }}'
    dest: '/home/{{ user_name }}/.oh-my-zsh/custom/plugins/{{ plugin }}/'
    clone: true
    depth: 1
    update: true
  with_items:
    - 'zsh-syntax-highlighting'
    - 'zsh-autosuggestions'
  loop_control:
    loop_var: plugin
  become: false

- name: zsh - Install fonts for Powerlevel10k theme (ONLY required when using Terminal Emultators in Desktop environments)
  ansible.builtin.apt:
    name:
      - fonts-powerline
    state: present

- name: zsh - Install Powerlevel10k theme
  ansible.builtin.git:
    repo: 'https://github.com/romkatv/powerlevel10k.git'
    dest: '/home/{{ user_name }}/.oh-my-zsh/custom/themes/powerlevel10k/'
    clone: true
    depth: 1
    update: true
  become: false


- name: zsh - Copy config files
  ansible.builtin.copy:
    src: '{{ config_file.src }}'
    dest: '/home/{{ user_name }}/.config/zsh/{{ config_file.dest_file }}'
    owner: '{{ user_name }}'
    group: '{{ user_name }}'
    mode: 0644
  with_items:
    - { src: 'zsh/zshrc', dest_file: '.zshrc' }
    - { src: 'zsh/zshenv', dest_file: '.zshenv' }
    - { src: 'zsh/p10k', dest_file: '.p10k.zsh' }    # 'Generated' using `p10k configure` (and just copied)
  loop_control:
    loop_var: config_file
  become: false

- name: zsh - Copy config files 2
  ansible.builtin.template:
    src: zsh/zshfunc.j2
    dest: '/home/{{ user_name }}/.config/zsh/.zshfunc'
  become: false

- name: zsh - Set config dir
  ansible.builtin.file:
    src: '/home/{{ user_name }}/.config/zsh/.zshenv'
    dest: '/home/{{ user_name }}/.zshenv'
    state: link
  become: false


- name: zsh - Change shell
  ansible.builtin.user:
    name: '{{ user_name }}'
    shell: /bin/zsh
