---
- name: Install open-vm-tools
  ansible.builtin.apt:
    name:
      - open-vm-tools
      - gvfs-fuse         # NOTE: Package `fuse` causes autoremove of GNOME packages (https://askubuntu.com/questions/1406236/desktop-icons-gone-in-22-04), hence install `gvfs-fuse`
    state: present

- name: Mount vmware shares on boot
  ansible.posix.mount:
    path: '{{ vmshares_mount_dir }}'
    src: 'vmhgfs-fuse'
    fstype: fuse
    opts: 'defaults,allow_other'
    state: mounted

- name: Create symlink in home dir
  ansible.builtin.file:
    src: '{{ vmshares_mount_dir }}'
    dest: '/home/{{ user_name }}/vmware-shares'
    state: link
  become: false



- name: "TODO (RMV ONCE FIXED): WORKAROUND for 'Unknown ioctl 1976'"
  ansible.builtin.blockinfile:
    block: |
      blacklist vsock_loopback
      blacklist vmw_vsock_virtio_transport_common
      install vsock_loopback /usr/bin/true
      install vmw_vsock_virtio_transport_common /usr/bin/true
    path: /etc/modprobe.d/blacklist.conf
    create: true
    owner: root
    group: root
    mode: 0644
  when: ansible_architecture == 'aarch64' and ansible_facts.distribution == 'Debian'
