version: "3.7"

networks:
  {{ docker_default_network }}:
    external: true

services:
  {{ container_name }}:
    image: haugene/transmission-openvpn:latest
    restart: "no"
    container_name: {{ container_name }}

    cap_add:
      - NET_ADMIN

    # ports:
    #   - "8888:8888"
    # dns:
    #   - 8.8.8.8
    #   - 8.8.4.4

    networks:
      - {{ docker_default_network }}

    devices:
      - /dev/net/tun

    volumes:
      - /etc/localtime:/etc/localtime:ro

      - ${BASE_DIR}/etc/vpn-profiles/${VPN_CONFIG_FILE}:/etc/openvpn/custom/default.ovpn
      - ${BASE_DIR}/${PUBLIC_DIR}/:/data

      # - ./scripts/transmission/hooks:/etc/scripts/hooks/

      - /${BASE_DIR}/var/.torrents:/config/torrents
      # - /${BASE_DIR}/var/transmission.log:/config/transmission.log
      # - /${BASE_DIR}/var/stats.json:/config/stats.json


#    logging:
#      driver: none

    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ={{ timezone }}

      - CREATE_TUN_DEVICE=true

      - OPENVPN_PROVIDER=CUSTOM
      - OPENVPN_USERNAME=XXX
      - OPENVPN_PASSWORD=XXX
      - OPENVPN_OPTS=--inactive 3600 --ping 10 --ping-exit 60

      - LOCAL_NETWORK=${LOCAL_NETWORK}

      - TRANSMISSION_WEB_UI=kettu

      - TRANSMISSION_RPC_HOST_WHITELIST_ENABLED=${TRANSMISSION_RPC_HOST_WHITELIST_ENABLED}
      - TRANSMISSION_RPC_HOST_WHITELIST=${TRANSMISSION_RPC_HOST_WHITELIST}

      - TRANSMISSION_RPC_AUTHENTICATION_REQUIRED=true
      - TRANSMISSION_RPC_USERNAME=${RPC_USERNAME}
      - TRANSMISSION_RPC_PASSWORD=${RPC_PASSWORD}

      - TRANSMISSION_UMASK=2
      - TRANSMISSION_HOME=./config

      - TRANSMISSION_RATIO_LIMIT=1.00
      - TRANSMISSION_RATIO_LIMIT_ENABLED=true
      #- TRANSMISSION_BLOCKLIST_ENABLED=${BLOCKLIST_ENABLED}
      #- TRANSMISSION_BLOCKLIST_URL=${BLOCKLIST_URL}
      #- TRANSMISSION_DOWNLOAD_QUEUE_SIZE=${MAX_PARALLEL_DOWNLOADS}
      # - TRANSMISSION_ENCRYPTION=1 #prefer encrypted connections
      - TRANSMISSION_SCRAPE_PAUSED_TORRENTS_ENABLED=false

      # Emailing
      #- TRANSMISSION_SCRIPT_TORRENT_DONE_ENABLED=${TRANSMISSION_SCRIPT_TORRENT_DONE_ENABLED}
      #- TRANSMISSION_SCRIPT_TORRENT_DONE_FILENAME=${TRANSMISSION_SCRIPT_TORRENT_DONE_FILENAME}
      #- NOTIFICATION_MAIL_SMTP_SERVER_HOST=${NOTIFICATIONS_MAIL_SERVER_HOST}
      #- NOTIFICATION_MAIL_SMTP_SERVER_PORT=465
      #- NOTIFICATION_MAIL_SERVER_USERNAME=${NOTIFICATIONS_MAIL_SERVER_USERNAME}
      #- NOTIFICATION_MAIL_SERVER_PASSWORD=${NOTIFICATIONS_MAIL_SERVER_PASSWORD}
      #- NOTIFICATION_MAIL_TO_ADDR=${SYSTEM_ADMIN_MAIL}
      #- NOTIFICATION_MAIL_HIDE_FILENAME=true

    labels:
     # Watchtower
      - com.centurylinklabs.watchtower.enable=false

     # Traefik
      - traefik.enable=true
      - traefik.http.services.{{ container_name }}_service.loadbalancer.server.port=9091
      - traefik.http.routers.{{ container_name }}_router.rule=Host(`{{ container_name }}.${DOMAINNAME}`)
