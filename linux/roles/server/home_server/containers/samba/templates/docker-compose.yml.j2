---
# {{ ansible_managed }}

version: '3.7'

services:
  # >>  Reference: https://hub.docker.com/r/dperson/samba  //  https://github.com/dperson/samba  <<
  {{ container_name }}:
    image: {{ container_image }}
    container_name: {{ container_name }}
    restart: unless-stopped
    hostname: {{ hostname }}

    network_mode: bridge
    ports:
{% if advertise_shares %}
      # netbios-ns – 137/tcp # NETBIOS Name Service
      - 137:137/udp
      # netbios-dgm – 138/tcp # NETBIOS Datagram Service
      - 138:138/udp
{% endif %}
      # netbios-ssn – 139/tcp # NETBIOS session service
      - 139:139/tcp
      # microsoft-ds – 445/tcp # if you are using Active Directory
      - 445:445/tcp

    volumes:
{% for share in samba_shares %}
{% for bind_mount in share.bind_mounts %}
      - {{ bind_mount }}
{% endfor %}
{% endfor %}

    # `-r` = Disable recycle bin for shares
    # `-n` = Start the 'nmbd' daemon to advertise the shares
    # `-s`syntax: "<name;/path>[;browsable;readonly;guest;users;admins;writelist;comment]"
    command: >
      -r
{% if advertise_shares %}
      -n
{% endif %}
      -w "{{ domainname }}"
{% for user in samba_users %}
      -u "{{ user.name }};{{ user.pass }}"
{% endfor %}
{% for share in samba_shares %}
      -s "{{ share.name }};{{ share.path }};{{ share.browsable }};{{ share.readonly }};{{ share.guest }};{{ share.users|join(',') }};none;;"
{% endfor %}

    environment:
      - TZ={{ timezone }}
      - USERID={{ www_user_uid }}
      - GROUPID={{ www_user_gid }}
      # Allow following symlinks
      - WIDELINKS={{ follow_symlinks }}

    security_opt:
      - no-new-privileges:true

    labels:
      - com.centurylinklabs.watchtower.enable=true
      - traefik.enable=false
