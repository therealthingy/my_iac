---
# {{ ansible_managed }}

version: "3.7"

networks:
  {{ reverse_proxy_docker_network }}:
    external: true

services:
  {{ container.name }}:
    image: containrrr/watchtower
    hostname: {{ container.name }}
    container_name: {{ container.name }}

    restart: always

    user: {{ www_user.uid }}:{{ www_user.gid }}
    security_opt:
      - no-new-privileges:true

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    networks:
      - {{ reverse_proxy_docker_network }}

    environment:
      - TZ={{ timezone }}

      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=true                            # Filter by enable label

{% if notifications_mail is defined %}
      - WATCHTOWER_NO_STARTUP_MESSAGE=true
      # - Emailing
      - WATCHTOWER_NOTIFICATIONS=email
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER={{ notifications_mail.smtp_host }}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT={{ notifications_mail.smtp_port }}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER={{ notifications_mail.smtp_username }}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD={{ notifications_mail.smtp_password }}
      - WATCHTOWER_NOTIFICATION_EMAIL_FROM={{ notifications_mail.smtp_username }}
      - WATCHTOWER_NOTIFICATION_EMAIL_TO={{ notifications_mail.system_admin_mail }}
      #- WATCHTOWER_NOTIFICATION_EMAIL_SUBJECTTAG={{ inventory_hostname }}
{% endif %}

      # - WATCHTOWER_SCHEDULE="<watchtower_cron_schedule>"
      # FORMAT: Seconds, Minutes, Hours, Day of month, Month, Day of week  (see https://pkg.go.dev/github.com/robfig/cron@v1.2.0#hdr-CRON_Expression_Format)
    command: --schedule "{{ watchtower_cron_schedule  if watchtower_cron_schedule is defined else '0 30 3 * * WED,SAT' }}"                   # TESTING: `--run-once`
