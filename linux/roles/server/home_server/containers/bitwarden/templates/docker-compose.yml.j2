version: '3.7'

networks:
  {{ docker_default_network }}:
    external: true

services:
  {{ container_name }}:
    image: vaultwarden/server
    container_name: {{ container_name }}
    restart: always

    user: {{ user_uid }}:{{ docker_gid }}
    # $$$ Required for binding to TCP/UDP sockets below 1024 (aka 'privileged ports') -> cap_add doesn't seem to work -> use sysctl instead... $$$
    # cap_add:
    #   - NET_BIND_SERVICE
    sysctls:
      - net.ipv4.ip_unprivileged_port_start=0

    environment:
      - TZ={{ timezone }}

      # --- General
      - DATA_FOLDER=/data
      - DATABASE_URL=/data/db.sqlite3
      - WEBSOCKET_ENABLED=true
      - SIGNUPS_ALLOWED={{ bitwarden_signups_allowed | default('false', true) }}
      - SIGNUPS_VERIFY={{ 'true' if notifications_mail_config is defined else 'false' }}
      - DOMAIN=https://{{ container_name }}.{{ domainname }}

{% if notifications_mail_config is defined %}
      # --- Emailing
      - SMTP_HOST={{ notifications_mail_config.smtp_host }}
      - SMTP_FROM={{ notifications_mail_config.smtp_username }}
      - SMTP_FROM_NAME=Bitwarden_RS
      - SMTP_PORT={{ notifications_mail_config.smtp_port }}
      - SMTP_SECURITY=starttls
      - SMTP_USERNAME={{ notifications_mail_config.smtp_username }}
      - SMTP_PASSWORD={{ notifications_mail_config.smtp_password }}
      - SMTP_AUTH_MECHANISM=Plain
      - SMTP_TIMEOUT=15
{% endif %}

    volumes:
      - {{ docker_container_data_basedir }}/{{ container_name }}/:/data

    networks:
      - {{ docker_default_network }}

    labels:
     # Watchtower
      - com.centurylinklabs.watchtower.enable=true

     # Traefik
      - traefik.enable=true
      - traefik.docker.network={{ docker_default_network }}
      - traefik.http.routers.bitwarden-ui-http.rule=Host(`{{ container_name }}.{{ domainname }}`)
      - traefik.http.routers.bitwarden-ui-http.service=bitwarden-ui
      - traefik.http.services.bitwarden-ui.loadbalancer.server.port=80
      - traefik.http.routers.bitwarden-websocket-http.rule=Host(`{{ container_name }}.{{ domainname }}`) && Path(`/notifications/hub`)
      - traefik.http.routers.bitwarden-websocket-http.service=bitwarden-websocket
      - traefik.http.services.bitwarden-websocket.loadbalancer.server.port=3012
