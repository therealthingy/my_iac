---
- name: "[Darwin] Setup brew autoupdate" #         << TODO: SHOULD BE VARIABLE
  # SEE: https://github.com/DomT4/homebrew-autoupdate
  #   ( DISABLE: `brew autoupdate delete` )
  #   ( SEE STATUS: brew autoupdate status )
  block:
    - name: Install deps
      community.general.homebrew: # (required 4 `-sudo` option)
        name: pinentry-mac
    - name: Create `LaunchAgents` dir
      ansible.builtin.file:
        path: "/Users/{{ user.name }}/Library/LaunchAgents/"
        state: directory
        owner: "{{ user.name }}"
        group: "staff"
        mode: 0700
    - name: Tap updater homebrew repo
      community.general.homebrew_tap:
        name: domt4/autoupdate
    - name: Check already installed
      ansible.builtin.stat:
        path: "/Users/{{ user.name }}/Library/LaunchAgents/com.github.domt4.homebrew-autoupdate.plist"
      register: brew_autoupdater
    - name: Install brew autoupdater
      ansible.builtin.shell: brew autoupdate start 43200 --upgrade --cleanup --immediate --sudo --ac-only # TODO: `--greedy` ?!
      when: brew_autoupdater.stat.exists == False
  become: false
  when: ansible_facts.os_family == 'Darwin'

# NOTE `defaults`:
#    - `-g` in `defaults` refers 2 `NSGlobalDomain`
#    - `defaults read-type <key>` reveals type info
# REFERENCE: https://macos-defaults.com/
# NOTE: 2 find out a setting:
#   BEFORE & AFTER CHANGING THE SETTING IN QUESTION: `defaults [-currentHost] read [-g] | codium -`
#   Diff both files

# NOTE: Show power settings: `sudo pmset -g`

# TODO:
#   - Add [dnsforge certificate](https://dnsforge.de/)
#   - Add login items
#   - Add wifi networks: `networksetup -setairportnetwork en0 WIFI_SSID WIFI_PASSWORD`

- name: "[Darwin] System-wide"
  block:
    - ansible.builtin.include_tasks: darwin/systemsetup_util.yml
      loop_control:
        loop_var: systemsetup_setting
      with_items:
        - setting: restartfreeze
          value: "Off"
        # Power settings
        - setting: computersleep
          value: "{{ 1 if host_is_a_macbook else 0 }}"
        - setting: displaysleep
          value: "{{ 5 if host_is_a_macbook else 15 }}"
        - setting: harddisksleep
          value: 0

    # TODO: Disable startup chime: System Preferences..., then click Sound. In the Sound Effects pane, use the ‚ÄúPlay sound on startup‚Äù setting to turn the startup sound on or off.

    # Security: TODO: Allow accessories 2 connect

    - name: "[Darwin] Set lock screen message"
      community.general.osx_defaults:
        domain: "/Library/Preferences/com.apple.loginwindow"
        key: "LoginwindowText"
        type: "string"
        value: "{{ lockscreen_msg }}"
        check_type: false
        state: present
      when: lockscreen_msg is defined

    - name: "[Darwin] Disable Optimized Battery Charging 4 AlDente"
      community.general.osx_defaults:
        domain: "{{ item.domain }}"
        key: "{{ item.key }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
        check_type: false
        state: present
      with_items:
        - domain: "com.apple.smartcharging.topoffprotection"
          key: "enabled"
          value: "false"
          type: "bool"
        - domain: "com.apple.smartcharging.topoffprotection"
          key: "currentState"
          value: "false"
          type: "bool"
  become: true
  when: ansible_facts.os_family == 'Darwin'

- name: "[Darwin] User-wide settings" # ( NOTE: Changes MAY only take effect after logging in again )
  block:
    - community.general.osx_defaults:
        domain: "{{ item.domain }}"
        key: "{{ item.key }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
        check_type: false
        state: present
      with_items:
        # --  Audio  --
        - domain: "NSGlobalDomain" # Play feedback when volume is changed; default
          key: "com.apple.sound.beep.feedback"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain"
          key: "com.apple.sound.uiaudio.enabled"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain"
          key: "com.apple.sound.beep.volume"
          value: "0"
          type: "float"
        # --  UI/UX  --
        - domain: "NSGlobalDomain" # Fileviewer dialog: Save 2 disk (not 2 iCloud) by default
          key: "NSDocumentSaveNewDocumentsToCloud"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Expand save panel by default
          key: "NSNavPanelExpandedStateForSaveMode"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain" # Show scrollbar (`WhenScrolling`, `Automatic` and `Always`); default
          key: "AppleShowScrollBars"
          value: "WhenScrolling"
          type: "string"
        # -  Appearance  -
        - domain: "com.apple.universalaccess" # Don't reduce transparency (Accessibility feature)
          key: "reduceTransparency"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Auto appearance (light <-> dark)
          key: "AppleInterfaceStyleSwitchesAutomatically"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain" # Accent color (Graphite)        << TODO: SHOULD BE VARIABLE
          key: "AppleAccentColor"
          value: "-1"
          type: "integer"
        - domain: "NSGlobalDomain" # Text highlight color (Graphite)        << TODO: SHOULD BE VARIABLE
          key: "AppleHighlightColor"
          value: "0.847059 0.847059 0.862745 Graphite"
          type: "string"
        # -  Menubar  -
        - domain: "com.apple.menuextra.clock" # Flash clock time separators; default
          key: "FlashDateSeparators"
          value: "false"
          type: "bool"
        - domain: "com.apple.menuextra.clock"
          key: "DateFormat"
          value: "EEE d MMM HH:mm"
          type: "string"
        # -  Desktop  -
        - domain: "com.apple.finder" # Sorting: Keep folders on top when sorting
          key: "_FXSortFoldersFirstOnDesktop"
          value: "true"
          type: "bool"
        - domain: "com.apple.WindowManager" # Disable "Click wallpaper to show desktop"
          key: "EnableStandardClickToShowDesktop"
          value: "false"
          type: "bool"
        - domain: "com.apple.finder" # Show all icons on desktop; default
          key: "CreateDesktop"
          value: "true"
          type: "bool"
        # ( Show icons for hard drives, connected servers, and removable media on the desktop )
        - domain: "com.apple.finder" # default
          key: "ShowHardDrivesOnDesktop"
          value: "false"
          type: "bool"
        - domain: "com.apple.finder" # default
          key: "ShowExternalHardDrivesOnDesktop"
          value: "true"
          type: "bool"
        - domain: "com.apple.finder" # default
          key: "ShowRemovableMediaOnDesktop"
          value: "true"
          type: "bool"
        - domain: "com.apple.finder" # default
          key: "ShowMountedServersOnDesktop"
          value: "true"
          type: "bool"
        # --  Dock  --
        - domain: "com.apple.dock" #        << TODO: SHOULD BE VARIABLE
          key: "orientation"
          value: "left"
          type: "string"
        - domain: "com.apple.dock" # Set the icon size of Dock items        << TODO: SHOULD BE VARIABLE
          key: "tilesize"
          value: "22.0"
          type: "float"
        - domain: "com.apple.dock"
          key: "autohide"
          value: "true"
          type: "bool"
        - domain: "com.apple.dock" # Eliminate Dock reveal delay
          key: "autohide-time-modifier"
          value: "0"
          type: "float"
        - domain: "com.apple.dock" # Eliminate Dock reveal delay
          key: "autohide-delay"
          value: "0"
          type: "float"
        #- domain: "com.apple.dock" # Enable spring loading for all Dock items;        TODO: ?!?!!11
        #  key: "enable-spring-load-actions-on-all-items"
        #  value: "false"
        #  type: "bool"
        - domain: "com.apple.dock" # Show indicator lights for open applications in the Dock; default
          key: "show-process-indicators"
          value: "true"
          type: "bool"
        - domain: "com.apple.dock" # Make Dock icons of hidden applications translucent
          key: "showhidden"
          value: "true"
          type: "bool"
        - domain: "com.apple.dock" # Enable highlight hover effect for the grid view of a stack (Dock)
          key: "mouse-over-hilite-stack"
          value: "true"
          type: "bool"
        - domain: "com.apple.dock"
          key: "show-recents"
          value: "false"
          type: "bool"
        - domain: "com.apple.dock" # Dock minimize animation (`genie`, `scale`, `suck`); default
          key: "mineffect"
          value: "genie"
          type: "string"
        - domain: "com.apple.dock"
          key: "scroll-to-open"
          value: "true"
          type: "bool"
        - domain: "com.apple.dock" # Only show opened apps in Dock; default
          key: "static-only"
          value: "false"
          type: "bool"
        #
        # TODO: Dock items  (SEE: https://stackoverflow.com/q/67026378)
        # com.apple.dock "persistent-apps"
        #   => when `dock_fav_apps` is defined
        #
        # --  Finder  --
        - domain: "com.apple.finder" # Use column view in all Finder windows by default
          key: "FXPreferredViewStyle"
          value: "icnv" # 4-letter codes for the other view modes: `icnv` = icon view, `Nlsv` = list view, `clmv` = column view, `Flwv` = cover flow view
          type: "string"
        - domain: "com.apple.finder" # Default group by (if appropriate `FXPreferredViewStyle`; `Name`, `Kind`, `DateModified`, `DateCreated`, `Size`, `Tags`)
          key: "FXPreferredGroupBy"
          value: "Kind"
          type: "string"
        - domain: "com.apple.finder" # Sorting: Keep folders on top when sorting by Name
          key: "_FXSortFoldersFirst"
          value: "true"
          type: "bool"
        ## TODO: Expand the following File Info panes:
        ## ‚ÄúGeneral‚Äù, ‚ÄúOpen with‚Äù, and ‚ÄúSharing & Permissions‚Äù
        #defaults write com.apple.finder FXInfoPanesExpanded -dict \
        #    General -bool true \
        #    OpenWith -bool true \
        #    Privileges -bool true
        - domain: "com.apple.finder" # Set Downloads as the default location for new Finder windows
          key: "ShowPathbar"
          value: "true"
          type: "bool"
        - domain: "com.apple.finder" # Finder: DON'T show status bar
          key: "ShowStatusBar"
          value: "false"
          type: "bool"
        - domain: "com.apple.finder" # Display full POSIX path as Finder window title
          key: "_FXShowPosixPathInTitle"
          value: "false"
          type: "bool"
        - domain: "com.apple.universalaccess" # Show folder icon before title in the title bar; default
          key: "showWindowTitlebarIcons"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Toolbar title rollover delay (`0` = off)
          key: "NSToolbarTitleViewRolloverDelay"
          value: "1"
          type: "int"
        - domain: "com.apple.finder" # Show hidden files by default        << TODO: SHOULD BE VARIABLE
          key: "AppleShowAllFiles"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain" # Show all filename extensions
          key: "AppleShowAllExtensions"
          value: "true"
          type: "bool"
        - domain: "com.apple.finder" # Disable the warning when changing a file extension        << TODO: SHOULD BE VARIABLE
          key: "FXEnableExtensionChangeWarning"
          value: "false"
          type: "bool"
        - domain: "com.apple.finder" # Cmd + double-click opens new tab (`true`) or new window (`false`); default
          key: "FinderSpawnTab"
          value: "true"
          type: "bool"
        - domain: "com.apple.finder" # Set Downloads as the default location for new Finder windows (`PfCm` = Computer, `PfVo` = Volume, `PfHm` = $HOME, `PfDe` = Desktop, `PfDo` = Documents, `PfAF` = All My Files, `PfLo` = Other ‚Ä¶)
          key: "NewWindowTarget"
          value: "PfLo"
          type: "string"
        - domain: "com.apple.finder"
          key: "NewWindowTargetPath"
          value: "file:///Users/{{ user.name }}/"
          type: "string"
        - domain: "com.apple.finder" # Allow text selection in Quick Look
          key: "QLEnableTextSelection"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain" # Enable spring loading 4 directories
          key: "com.apple.springing.enabled"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain" # Remove the spring loading delay 4 directories
          key: "com.apple.springing.delay"
          value: "0.3"
          type: "float"
        - domain: "com.apple.finder" # Default search scope  (`SCcf` = current folder, `SCev` = this Mac)
          key: "FXDefaultSearchScope"
          value: "SCcf"
          type: "string"
        - domain: "com.apple.finder" # Empty bin items after 30 days; default
          key: "FXRemoveOldTrashItems"
          value: "false"
          type: "bool"
        - domain: "com.apple.finder" # Disable the "Show warning before emptying the Trash" warning        << TODO: SHOULD BE VARIABLE
          key: "WarnOnEmptyTrash"
          value: "false"
          type: "bool"
        - domain: "com.apple.finder" # Disable Window animations and Get Info animations; default
          key: "DisableAllAnimations"
          value: "false"
          type: "bool"
        - domain: "com.apple.finder" # NOT RECOMMENDED!; default
          key: "QuitMenuItem"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Sidebar icon size (`1` = small, `2` = medium, `3` = large)
          key: "NSTableViewDefaultSizeMode"
          value: "1"
          type: "int"
        # -  Metadata files  -
        - domain: "com.apple.desktopservices" # Avoid creating .DS_Store files on network volumes
          key: "DSDontWriteNetworkStores"
          value: "true"
          type: "bool"
        - domain: "com.apple.desktopservices" # Avoid creating .DS_Store files on USB drives
          key: "DSDontWriteUSBStores"
          value: "true"
          type: "bool"
        # --  Input  --
        # -  Trackpad & Mouse  -
        # - Point & Click
        # Mouse speed
        - domain: "NSGlobalDomain" # Pertains 2 trackpad
          key: "com.apple.trackpad.scaling"
          value: "3"
          type: "float"
        - domain: "NSGlobalDomain" # Pertains 2 mouse
          key: "com.apple.mouse.scaling"
          value: "3"
          type: "float"
        - domain: "NSGlobalDomain" # Disable mouse acceleration; default
          key: "com.apple.mouse.linear"
          value: "false"
          type: "bool"
        # Click weight (threshold) (`0` = light, `1` = medium, `2` = firm); default
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "FirstClickThreshold"
          value: "1"
          type: "int"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "SecondClickThreshold"
          value: "1"
          type: "int"
        # Disable forcetouch
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.forceClick"
          value: "false"
          type: "bool"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "ForceSuppressed"
          value: "true"
          type: "bool"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "ActuateDetents"
          value: "false"
          type: "bool"
        # Enable natural scroll direction (affects trackpad AND mouse); default        << TODO: SHOULD BE VARIABLE
        - domain: "NSGlobalDomain"
          key: "com.apple.swipescrolldirection"
          value: "true"
          type: "bool"
        # - Gestures
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadRightClick"
          value: "true"
          type: "boolean"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadRightClick"
          value: "true"
          type: "boolean"
        - domain: "NSGlobalDomain"
          key: "ContextMenuGesture"
          value: "1"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "AppleEnableSwipeNavigateWithScrolls"
          value: "true"
          type: "bool"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadFourFingerHorizSwipeGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadFourFingerHorizSwipeGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadPinch"
          value: "true"
          type: "bool"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadPinch"
          value: "true"
          type: "bool"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadRotate"
          value: "true"
          type: "bool"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadRotate"
          value: "true"
          type: "bool"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadFiveFingerPinchGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadFiveFingerPinchGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadFourFingerPinchGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadFourFingerPinchGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadFourFingerVertSwipeGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadFourFingerVertSwipeGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadThreeFingerHorizSwipeGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadThreeFingerHorizSwipeGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadTwoFingerDoubleTapGesture"
          value: "1"
          type: "int"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadTwoFingerDoubleTapGesture"
          value: "1"
          type: "int"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadTwoFingerFromRightEdgeSwipeGesture"
          value: "3"
          type: "int"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadTwoFingerFromRightEdgeSwipeGesture"
          value: "3"
          type: "int"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "TrackpadThreeFingerVertSwipeGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "TrackpadThreeFingerVertSwipeGesture"
          value: "2"
          type: "int"
        - domain: "com.apple.dock"
          key: "showAppExposeGestureEnabled"
          value: "true"
          type: "bool"
        - domain: "com.apple.dock"
          key: "showDesktopGestureEnabled"
          value: "true"
          type: "bool"
        - domain: "com.apple.dock"
          key: "showMissionControlGestureEnabled"
          value: "true"
          type: "bool"
        #
        # Tap 2 Click (I)
        - domain: "com.apple.driver.AppleBluetoothMultitouch.trackpad"
          key: "Clicking"
          value: "true"
          type: "bool"
        - domain: "com.apple.AppleMultitouchTrackpad"
          key: "Clicking"
          value: "true"
          type: "bool"
        # Dragging
        - domain: "com.apple.AppleMultitouchTrackpad" # Dragging w/ drag lock (mutually exclusive w/ `Dragging` & `TrackpadThreeFingerDrag`); default
          key: "DragLock"
          value: "false"
          type: "bool"
        - domain: "com.apple.AppleMultitouchTrackpad" # Dragging w/o drag lock (mutually exclusive w/ `DragLock` & `TrackpadThreeFingerDrag`); default
          key: "Dragging"
          value: "false"
          type: "bool"
        - domain: "com.apple.AppleMultitouchTrackpad" # Dragging w/ 3 finger drag (mutually exclusive w/ `Dragging` & `DragLock`); default
          key: "TrackpadThreeFingerDrag"
          value: "false"
          type: "bool"
        #
        - domain: "com.apple.Terminal" # default
          key: "FocusFollowsMouse"
          value: "false"
          type: "bool"
        # -  Keyboard  -
        - domain: "com.apple.HIToolbox" # Fn/üåê key usage (`1` = Change input source, `2` =  Show Emoji & Symbols, `3` = Start Dictation)
          key: "AppleFnUsageType"
          value: "2"
          type: "int"
        - domain: "NSGlobalDomain" # Function keys behavior ?; default
          key: "com.apple.keyboard.fnState"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Keyboard navigation (moving focus w/ Tab & Shift Tab; `0` = disabled, `2` = enabled)
          key: "AppleKeyboardUIMode"
          value: "2"
          type: "int"
        - domain: "kCFPreferencesAnyApplication" # Turn off the language indicator while switching input sources; default
          key: "TSMLanguageIndicatorEnabled"
          value: "true"
          type: "bool"
        # -  Typing  -
        # ( Set a blazingly fast keyboard repeat rate, and make it happen more quickly   (doesn't make a difference as of now, as press-and-hold is enabled) )
        - domain: "NSGlobalDomain" # ENABLE press-and-hold (e.g., ≈Ñ popup after long pressing n, ‚Ä¶) 4 keys in favor of key repeat; default
          key: "ApplePressAndHoldEnabled"
          value: "true" # NOTE: MUST BE `false` 2 have blazing fast keyboard repeats
          type: "bool"
        - domain: "NSGlobalDomain"
          key: "InitialKeyRepeat"
          value: "20"
          type: "float"
        - domain: "NSGlobalDomain"
          key: "KeyRepeat"
          value: "1"
          type: "float"
        - domain: "NSGlobalDomain" # Disable smart quotes
          key: "NSAutomaticQuoteSubstitutionEnabled"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Disable smart dashes
          key: "NSAutomaticDashSubstitutionEnabled"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Disable auto-correct
          key: "NSAutomaticSpellingCorrectionEnabled"
          value: "false"
          type: "bool"
        # --  Mission Control  --
        - domain: "com.apple.dock" # Speed up Mission Control animations
          key: "expose-animation-duration"
          value: "0.15"
          type: "float"
        #
        # Hot corners
        #   Possible values:
        #      0: no-op
        #      2: Mission Control
        #      3: Show application windows
        #      4: Desktop
        #      5: Start screen saver
        #      6: Disable screen saver
        #      7: Dashboard
        #     10: Put display to sleep
        #     11: Launchpad
        #     12: Notification Center
        # Bottom right screen corner ‚Üí Mission Control
        - domain: "com.apple.dock"
          key: "wvous-br-corner"
          value: "0"
          type: "int"
        - domain: "com.apple.dock"
          key: "wvous-br-modifier"
          value: "0"
          type: "int"
        - domain: "com.apple.dock"
          key: "wvous-tr-corner"
          value: "0"
          type: "int"
        - domain: "com.apple.dock"
          key: "wvous-tr-modifier"
          value: "0"
          type: "int"
        - domain: "com.apple.dock"
          key: "wvous-bl-corner"
          value: "0"
          type: "int"
        - domain: "com.apple.dock"
          key: "wvous-bl-modifier"
          value: "0"
          type: "int"
        - domain: "com.apple.dock" # Rearrange Spaces automatically (`true` = based on most recent use)
          key: "mru-spaces"
          value: "false"
          type: "bool"
        - domain: "com.apple.dock" # Group windows by application; default
          key: "expose-group-apps"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain" # When switching 2 an app, switch 2 a space w/ open windows 4 this app; default
          key: "AppleSpacesSwitchOnActivate"
          value: "true"
          type: "bool"
        - domain: "com.apple.spaces" # Displays have separate Spaces; default
          key: "spans-displays"
          value: "false"
          type: "bool"
        # --  Screenshots  --
        - domain: "com.apple.screencapture" # Disable shadow in screenshots; default
          key: "disable-shadow"
          value: "false"
          type: "bool"
        - domain: "com.apple.screencapture" # Include in filename date; default
          key: "include-date"
          value: "true"
          type: "bool"
        #- domain: "com.apple.screencapture" # Save screenshots 2 Downloads folder
        #  key: "location"
        #  value: "/Users/{{ user.name }}/Downloads"
        #  type: "string"
        - domain: "com.apple.screencapture" # Show thumbnail; default
          key: "show-thumbnail"
          value: "true"
          type: "bool"
        - domain: "com.apple.screencapture" # Save screenshots in PNG format (`png`, `jpg`, `pdf`, `psd`, `gif`, `tga`, `tiff`, `bmp`, `heic`); default
          key: "type"
          value: "png"
          type: "string"
        # --  Time Machine  --
        - domain: "com.apple.TimeMachine" # Don't offer new disks 4 TM backup
          key: "DoNotOfferNewDisksForBackup"
          value: "true"
          type: "bool"
        # --  Apps  --
        # -  Activity Monitor  -
        - domain: "com.apple.ActivityMonitor" # Show the main window when launching Activity Monitor
          key: "OpenMainWindow"
          value: "true"
          type: "bool"
        - domain: "com.apple.ActivityMonitor" # Show all processes in Activity Monitor
          key: "ShowCategory"
          value: "0"
          type: "int"
        - domain: "com.apple.ActivityMonitor" # Update Frequency in sec (`1` = very often, `2` = often, `5` = normally)
          key: "UpdatePeriod"
          value: "2"
          type: "int"
        - domain: "com.apple.ActivityMonitor" # Update Frequency in sec (`0` = regular icon, `2` = network usage, `3` = disk usage, `5` = CPU usage)
          key: "IconType"
          value: "5"
          type: "int"
        # -  Safari & WebKit  -
        - domain: "com.apple.Safari" # Show full URL; default
          key: "ShowFullURLInSmartSearchField"
          value: "false"
          type: "bool"
        # TODO: Don't work
        ## Enable the Develop menu and the Web Inspector in Safari
        #- domain: 'com.apple.Safari'
        #  key: 'IncludeDevelopMenu'
        #  value: 'true'
        #  type: 'bool'
        #- domain: 'com.apple.Safari'
        #  key: 'WebKitDeveloperExtrasEnabledPreferenceKey'
        #  value: 'true'
        #  type: 'bool'
        #- domain: 'com.apple.Safari'
        #  key: 'com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled'
        #  value: 'true'
        #  type: 'bool'
        ## Add a context menu item for showing the Web Inspector in web views
        #- domain: 'NSGlobalDomain'
        #  key: 'WebKitDeveloperExtras'
        #  value: 'true'
        #  type: 'bool'
        ## -  Mail  -
        #- domain: 'com.apple.mail'                       # Copy email addresses as `foo@example.com` instead of `Foo Bar <foo@example.com>` in Mail.app
        #  key: 'AddressesIncludeNameOnPasteboard'
        #  value: 'false'
        #  type: 'bool'
        # -  TextEdit  -
        - domain: "com.apple.TextEdit" # Default document format
          key: "RichText"
          value: "false"
          type: "bool"
        - domain: "com.apple.TextEdit" # Convert from neutral form 2 opening/closing variants; default
          key: "SmartQuotes"
          value: "true"
          type: "bool"
        # - TODO:  Messages  -
        ## Disable smart quotes as it‚Äôs annoying for messages that contain code
        #defaults write com.apple.messageshelper.MessageController SOInputLineSettings -dict-add "automaticQuoteSubstitutionEnabled" -bool false
        ## Disable continuous spell checking
        #defaults write com.apple.messageshelper.MessageController SOInputLineSettings -dict-add "continuousSpellCheckingEnabled" -bool false
        # --  Misc.  --
        - domain: "NSGlobalDomain" # Close confirm changes popup
          key: "NSCloseAlwaysConfirmsChanges"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Close confirm changes popup
          key: "NSCloseAlwaysConfirmsChanges"
          value: "false"
          type: "bool"
        - domain: "NSGlobalDomain" # Keep windows when quitting an application
          key: "NSQuitAlwaysKeepsWindow"
          value: "false"
          type: "bool"
        - domain: "com.apple.loginwindow" # "Reopen windows when logging in"
          key: "TALLogoutSavesState"
          value: "false"
          type: "bool"
        # -  Localization  -
        # TODO: Region
        - domain: "NSGlobalDomain"
          key: "AppleLanguages"
          value:
            - "en-US"
            - "de-DE"
          type: "array"
        - domain: "NSGlobalDomain" # 12h clock        << TODO: SHOULD BE VARIABLE
          key: "AppleICUForce12HourTime"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain"
          key: "AppleMetricUnits"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain"
          key: "AppleMeasurementUnits"
          value: "Centimeters"
          type: "string"
        - domain: "NSGlobalDomain"
          key: "AppleTemperatureUnit"
          value: "Celsius"
          type: "string"
        # TODO: Date format  => `AppleICUDateFormatStrings`
        ## -  TODO: Disk image verification  -
        #defaults write com.apple.frameworks.diskimages skip-verify        -bool true
        #defaults write com.apple.frameworks.diskimages skip-verify-locked -bool true
        #defaults write com.apple.frameworks.diskimages skip-verify-remote -bool true

    - community.general.osx_defaults:
        domain: "{{ item.domain }}"
        key: "{{ item.key }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
        host: currentHost
        check_type: false
        state: present
      with_items:
        - domain: "com.apple.controlcenter" # Show battery percentage
          key: "BatteryShowPercentage"
          value: "true"
          type: "bool"
        # Trackpad -> Point & Click
        - domain: "NSGlobalDomain" # Tap 2 Click (II)
          key: "com.apple.mouse.tapBehavior"
          value: "true"
          type: "bool"
        # Trackpad -> Gestures
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.enableSecondaryClick"
          value: "true"
          type: "bool"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.fiveFingerPinchSwipeGesture"
          value: "2"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.fourFingerHorizSwipeGesture"
          value: "2"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.fourFingerPinchSwipeGesture"
          value: "2"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.fourFingerVertSwipeGesture"
          value: "2"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.pinchGesture"
          value: "1"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.rotateGesture"
          value: "1"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.threeFingerHorizSwipeGesture"
          value: "2"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.threeFingerVertSwipeGesture"
          value: "2"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.twoFingerDoubleTapGesture"
          value: "1"
          type: "int"
        - domain: "NSGlobalDomain"
          key: "com.apple.trackpad.twoFingerFromRightEdgeSwipeGesture"
          value: "3"
          type: "int"

    - ansible.builtin.include_tasks: darwin/plistbuddy_util.yml
      loop_control:
        loop_var: plist_setting
      with_items:
        # Size of icons on the desktop and in other icon views; default: `64`
        - key: ":DesktopViewSettings:IconViewSettings:iconSize"
          value: "32"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        - key: ":FK_StandardViewSettings:IconViewSettings:iconSize"
          value: "64"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        - key: ":StandardViewSettings:IconViewSettings:iconSize"
          value: "64"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        # Grid spacing 4 icons on the desktop and in other icon views; default: `54`
        - key: ":DesktopViewSettings:IconViewSettings:gridSpacing"
          value: "54"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        - key: ":FK_StandardViewSettings:IconViewSettings:gridSpacing"
          value: "54"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        - key: ":StandardViewSettings:IconViewSettings:gridSpacing"
          value: "54"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        # Show item info near icons on the desktop and in other icon views (default: false)
        - key: ":DesktopViewSettings:IconViewSettings:showItemInfo"
          value: "true"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        - key: ":FK_StandardViewSettings:IconViewSettings:showItemInfo"
          value: "true"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        - key: ":StandardViewSettings:IconViewSettings:showItemInfo"
          value: "true"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        # Show item info about the icons on the desktop (default: false)
        - key: "DesktopViewSettings:IconViewSettings:labelOnBottom"
          value: "true"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        #
        - key: ":DesktopViewSettings:GroupBy" # ~~Group~~Stack by (on Desktop)
          value: "Kind"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        # Sort by name 4 icons on the desktop and in other icon views
        - key: ":DesktopViewSettings:IconViewSettings:arrangeBy" # (‚Ä¶ on Desktop)
          value: "Name"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        - key: ":FK_StandardViewSettings:IconViewSettings:arrangeBy"
          value: "Name"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"
        - key: ":StandardViewSettings:IconViewSettings:arrangeBy"
          value: "Name"
          file: "/Users/{{ user.name }}/Library/Preferences/com.apple.finder.plist"

    - name: Set wallpaper #         << TODO: SHOULD BE VARIABLE
      block:
        - name: Get current wallpaper
          ansible.builtin.shell: osascript -e 'tell app "Finder" to get posix path of (get desktop picture as alias)'
          register: result_current_wallpaper
          failed_when: false
          changed_when: false # NOTE: Doesn't work seem 2 work w/ dynamic wallpapers or Ventura live wallpapers
        - name: Set new wallpaper
          ansible.builtin.command: osascript -e 'tell app "Finder" to set desktop picture to POSIX file "{{ wallpaper }}"'
          when: result_current_wallpaper.rc != 0  or  wallpaper != result_current_wallpaper.stdout
  become: false
  notify: "restart darwin daemons"
  when: ansible_facts.os_family == 'Darwin'
  tags:
    - user_config

# ------------------------------------------------------------------------------------------------------------------------------------------------------

# Must be enabled via: System Settings -> Privacy & Security -> Extensions -> Finder
- name: Finder services
  ansible.builtin.unarchive:
    src: "darwin/finder_workflows/{{ workflow_file }}.tar.gz"
    dest: "/Users/{{ user.name }}/Library/Services/"
    creates: "{{ workflow_file }}"
    owner: "{{ user.name }}"
    group: "{{ user.group_name }}"
    mode: 0755
  with_items:
    - "Clean LaTeX Junk.workflow"
    - "Combine PDFs.workflow"
    - "Convert PDFs to images.workflow"
    - "MP4 to MP3.workflow"
    - "Video to GIF.workflow"
  loop_control:
    loop_var: workflow_file
  become: false
  when: ansible_facts.os_family == 'Darwin'
